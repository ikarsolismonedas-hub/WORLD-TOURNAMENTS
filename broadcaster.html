<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Soy el streamer - Compartir pantalla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #192345 0, #050712 55%);
      color: #f9fafb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .page {
      width: 100%;
      max-width: 600px;
      background: #050712;
      border-radius: 18px;
      padding: 24px 20px;
      border: 1px solid rgba(0,255,198,0.18);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
    }

    h1 {
      font-size: 22px;
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.emoji {
      font-size: 26px;
    }

    p {
      margin: 0 0 16px;
      font-size: 14px;
      color: #9ca3c7;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
    }

    #btn-start {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #020617;
      flex: 1;
    }

    #btn-stop {
      background: #1f2937;
      color: #e5e7eb;
      min-width: 90px;
    }

    #status {
      font-size: 13px;
      margin-bottom: 10px;
      color: #9ca3c7;
    }

    .preview-wrapper {
      background: radial-gradient(circle at top, #1b2138, #020617);
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.4);
    }

    #preview {
      width: 100%;
      max-height: 360px;
      display: block;
      background: #000;
    }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      color: #64748b;
    }
  </style>
</head>
<body>

  <div class="page">
    <h1><span class="emoji">üé•</span> Soy el streamer - Compartir pantalla</h1>
    <p>
      Al comenzar, quienes est√©n en el ranking ver√°n tu pantalla en la secci√≥n
      <strong>‚ÄúTransmisi√≥n en vivo‚Äù</strong>.
    </p>

    <div class="btn-row">
      <button id="btn-start">üöÄ Comenzar transmisi√≥n</button>
      <button id="btn-stop" disabled>‚èπ Detener</button>
    </div>

    <div id="status">Listo para transmitir desde tu PC.</div>

    <div class="preview-wrapper">
      <video id="preview" autoplay playsinline muted></video>
    </div>

    <div class="hint">
      üëâ La mayor√≠a de navegadores de celular <strong>no permiten compartir pantalla</strong>.
      Usa este panel desde una PC (Chrome / Edge / Firefox) para transmitir tus jugadas.
    </div>
  </div>

  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <script>
    // URL de tu servidor de se√±alizaci√≥n en Render
    const SIGNALING_URL = "https://streaming-torneos-server-1.onrender.com";

    const socket = io(SIGNALING_URL);
    const startBtn = document.getElementById("btn-start");
    const stopBtn  = document.getElementById("btn-stop");
    const preview  = document.getElementById("preview");
    const statusEl = document.getElementById("status");

    const rtcConfig = {
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    let screenStream = null;
    let peers = {}; // watcherId -> RTCPeerConnection

    function setStatus(text) {
      statusEl.textContent = text;
    }

    async function startBroadcast() {
      if (screenStream) return;

      // üí° Comprobamos si el navegador soporta compartir pantalla
      if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
        alert(
          "Tu navegador no permite compartir pantalla.\n\n" +
          "Puedes transmitir desde una PC (Chrome / Edge / Firefox) y los dem√°s " +
          "lo ver√°n en el ranking."
        );
        return;
      }

      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({
          video: { frameRate: 30 },
          audio: false
        });

        preview.srcObject = screenStream;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        setStatus("Transmitiendo tu pantalla. Abre el ranking para ver c√≥mo se ve.");

        // Avisar al servidor que hay un broadcaster
        socket.emit("broadcaster");

        // Si el usuario detiene desde el cuadro del sistema
        screenStream.getVideoTracks()[0].addEventListener("ended", stopBroadcast);
      } catch (err) {
        console.error(err);
        alert("No se pudo iniciar la transmisi√≥n.");
        setStatus("Error al iniciar transmisi√≥n.");
      }
    }

    function stopBroadcast() {
      if (screenStream) {
        screenStream.getTracks().forEach(t => t.stop());
        screenStream = null;
      }

      Object.values(peers).forEach(pc => pc.close());
      peers = {};
      preview.srcObject = null;

      startBtn.disabled = false;
      stopBtn.disabled = true;

      setStatus("Transmisi√≥n detenida.");
      socket.emit("broadcast-ended");
    }

    startBtn.addEventListener("click", startBroadcast);
    stopBtn.addEventListener("click", stopBroadcast);
    window.addEventListener("beforeunload", stopBroadcast);

    // üëÄ Cuando un espectador se conecta
    socket.on("watcher", async (id) => {
      if (!screenStream) return;

      const pc = new RTCPeerConnection(rtcConfig);
      peers[id] = pc;

      screenStream.getTracks().forEach(track => pc.addTrack(track, screenStream));

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("candidate", id, event.candidate);
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("offer", id, pc.localDescription);
    });

    // Recibir answer de un viewer
    socket.on("answer", (id, description) => {
      const pc = peers[id];
      if (pc) {
        pc.setRemoteDescription(description);
      }
    });

    // Candidatos ICE desde viewers
    socket.on("candidate", (id, candidate) => {
      const pc = peers[id];
      if (pc && candidate) {
        pc.addIceCandidate(new RTCIceCandidate(candidate));
      }
    });

    // Viewer se desconecta
    socket.on("disconnectPeer", (id) => {
      const pc = peers[id];
      if (pc) {
        pc.close();
        delete peers[id];
      }
    });
  </script>
</body>
</html>
